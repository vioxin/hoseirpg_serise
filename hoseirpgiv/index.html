<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ほうせいRPG4 〜社畜の伝説〜</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');

    :root {
        --bg-color: #1a1a1a;
        --game-bg: #000;
        --ui-border: #fff;
    }

    body {
        background: var(--bg-color);
        margin: 0;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        font-family: 'DotGothic16', sans-serif;
        color: white;
    }

    /* ゲーム画面のコンテナ（ブラウン管風エフェクト用） */
    #game-container {
        position: relative;
        width: 640px;
        height: 480px;
        background: var(--game-bg);
        border: 4px solid #444;
        box-shadow: 0 0 20px rgba(0,0,0,0.8);
        image-rendering: pixelated; /* ドットをくっきり */
    }

    canvas {
        display: block;
        width: 100%;
        height: 100%;
    }

    /* UIオーバーレイ（メッセージウィンドウなど） */
    #ui-layer {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }

    .message-box {
        background: rgba(0, 0, 0, 0.85);
        border: 4px solid #fff;
        border-radius: 4px;
        margin: 20px;
        padding: 15px;
        min-height: 100px;
        font-size: 20px;
        line-height: 1.5;
        text-shadow: 2px 2px 0 #000;
        display: none; /* JSで制御 */
    }

    .status-bar {
        position: absolute;
        top: 0; left: 0; width: 100%;
        background: rgba(0,0,0,0.7);
        padding: 5px 10px;
        display: flex;
        gap: 20px;
        font-size: 16px;
        border-bottom: 2px solid #fff;
    }

    /* スマホ用コントローラー */
    #mobile-controls {
        position: fixed;
        bottom: 20px; left: 20px; right: 20px;
        height: 120px;
        display: none; /* PCでは非表示 */
        pointer-events: auto;
        justify-content: space-between;
        z-index: 100;
    }
    @media (max-width: 800px) {
        #game-container { width: 100%; height: 60vh; border: none; }
        #mobile-controls { display: flex; }
    }

    .dpad {
        position: relative; width: 120px; height: 120px;
    }
    .dbtn {
        position: absolute; width: 40px; height: 40px;
        background: rgba(255,255,255,0.2);
        border: 2px solid rgba(255,255,255,0.5);
    }
    .dbtn:active { background: rgba(255,255,255,0.5); }
    .btn-u { top: 0; left: 40px; }
    .btn-d { bottom: 0; left: 40px; }
    .btn-l { top: 40px; left: 0; }
    .btn-r { top: 40px; right: 0; }

    .action-btn {
        width: 80px; height: 80px;
        background: rgba(255,0,0,0.3);
        border: 2px solid rgba(255,100,100,0.8);
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; color: white; margin-top: 20px;
    }
    .action-btn:active { background: rgba(255,0,0,0.6); }

</style>
</head>
<body>

<div id="game-container">
    <div class="status-bar">
        <span>LV: <span id="s-lv">1</span></span>
        <span>HP: <span id="s-hp">100</span></span>
        <span>¥: <span id="s-money">1000</span></span>
        <span>JOB: <span id="s-job">ニート</span></span>
    </div>
    <canvas id="gameCanvas" width="320" height="240"></canvas>
    
    <div id="ui-layer">
        <div id="msg-box" class="message-box"></div>
    </div>
</div>

<div id="mobile-controls">
    <div class="dpad">
        <div class="dbtn btn-u" ontouchstart="input.setDir('UP')" ontouchend="input.stopDir()"></div>
        <div class="dbtn btn-d" ontouchstart="input.setDir('DOWN')" ontouchend="input.stopDir()"></div>
        <div class="dbtn btn-l" ontouchstart="input.setDir('LEFT')" ontouchend="input.stopDir()"></div>
        <div class="dbtn btn-r" ontouchstart="input.setDir('RIGHT')" ontouchend="input.stopDir()"></div>
    </div>
    <div class="action-btn" ontouchstart="input.setAction()" ontouchend="input.stopAction()">A</div>
</div>

<script>
/**
 * ほうせいRPG4 Core Engine
 * Canvas APIを使用した本格的RPGエンジン
 */

// --- Constants ---
const TILE_SIZE = 32;
const SCREEN_W = 320;
const SCREEN_H = 240;
const MAP_W = 40;
const MAP_H = 40;

// タイル定義 (色と属性)
const TILES = {
    GRASS: { id: 0, color: '#4caf50', walk: true },
    WATER: { id: 1, color: '#2196f3', walk: false },
    WALL:  { id: 2, color: '#795548', walk: false }, // 木や壁
    FLOOR: { id: 3, color: '#9e9e9e', walk: true },  // コンクリ
    DESK:  { id: 4, color: '#5d4037', walk: false }, // 机
    
    // イベント用特殊タイル
    SHOP:  { id: 10, color: '#ff9800', walk: false },
    BED:   { id: 11, color: '#e91e63', walk: false },
    PC:    { id: 12, color: '#607d8b', walk: false }
};

// --- Global State ---
const state = {
    player: {
        x: 5 * TILE_SIZE, // ピクセル単位の座標
        y: 5 * TILE_SIZE,
        dir: 2, // 0:上, 1:右, 2:下, 3:左
        speed: 2, // 移動速度
        moving: false,
        lv: 1, hp: 100, maxHp: 100, money: 1000, job: 'ニート'
    },
    camera: { x: 0, y: 0 },
    map: [],
    events: []
};

// --- Graphics Generator (擬似スプライト生成) ---
// 画像ファイルなしでリッチな見た目にするため、オフスクリーンCanvasに描画
const assets = {};

function createAsset(key, drawFn) {
    const c = document.createElement('canvas');
    c.width = TILE_SIZE;
    c.height = TILE_SIZE;
    const ctx = c.getContext('2d');
    drawFn(ctx);
    assets[key] = c;
}

function initAssets() {
    // プレイヤー (顔)
    createAsset('player', (ctx) => {
        ctx.fillStyle = '#ffcc80'; // 肌
        ctx.fillRect(4, 4, 24, 24);
        ctx.fillStyle = '#000'; // 目
        ctx.fillRect(8, 10, 4, 4);
        ctx.fillRect(20, 10, 4, 4);
        ctx.fillStyle = '#d32f2f'; // 口
        ctx.fillRect(10, 20, 12, 2);
    });

    // 草
    createAsset('grass', (ctx) => {
        ctx.fillStyle = '#4caf50';
        ctx.fillRect(0,0,32,32);
        ctx.fillStyle = '#81c784'; // 模様
        ctx.fillRect(4,4,4,4); ctx.fillRect(20,20,6,6);
    });
    
    // 壁（レンガ）
    createAsset('wall', (ctx) => {
        ctx.fillStyle = '#795548';
        ctx.fillRect(0,0,32,32);
        ctx.strokeStyle = '#5d4037';
        ctx.lineWidth = 2;
        ctx.strokeRect(2,2,28,28);
        ctx.beginPath(); ctx.moveTo(0,16); ctx.lineTo(32,16); ctx.stroke();
    });

    // 水
    createAsset('water', (ctx) => {
        ctx.fillStyle = '#2196f3';
        ctx.fillRect(0,0,32,32);
        ctx.fillStyle = '#64b5f6'; // 波
        ctx.fillRect(5,10,10,2); ctx.fillRect(18,20,10,2);
    });
}

// --- Map System ---
function generateMap() {
    // シンプルなマップ生成 (周囲を壁、中をランダム)
    for(let y=0; y<MAP_H; y++) {
        let row = [];
        for(let x=0; x<MAP_W; x++) {
            if(x===0 || x===MAP_W-1 || y===0 || y===MAP_H-1) {
                row.push(TILES.WALL.id);
            } else {
                let r = Math.random();
                if(r < 0.1) row.push(TILES.WALL.id);
                else if(r < 0.15) row.push(TILES.WATER.id);
                else row.push(TILES.GRASS.id);
            }
        }
        state.map.push(row);
    }
    // 特定の建物（イベント用）
    state.map[4][8] = TILES.SHOP.id; // 店
    state.map[6][6] = TILES.BED.id;  // 家のベッド
}

function getTileAt(pixelX, pixelY) {
    const tx = Math.floor(pixelX / TILE_SIZE);
    const ty = Math.floor(pixelY / TILE_SIZE);
    if(tx < 0 || tx >= MAP_W || ty < 0 || ty >= MAP_H) return TILES.WALL;
    
    const id = state.map[ty][tx];
    return Object.values(TILES).find(t => t.id === id) || TILES.GRASS;
}

// --- Input Handling ---
const input = {
    keys: { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, z: false },
    dir: null,
    action: false,

    init: function() {
        window.addEventListener('keydown', e => {
            if(this.keys.hasOwnProperty(e.key)) this.keys[e.key] = true;
            if(e.key === 'z' || e.key === 'Enter') this.action = true;
        });
        window.addEventListener('keyup', e => {
            if(this.keys.hasOwnProperty(e.key)) this.keys[e.key] = false;
            if(e.key === 'z' || e.key === 'Enter') this.action = false;
        });
    },
    
    // Mobile Touch
    setDir: function(d) {
        if(d==='UP') this.keys.ArrowUp = true;
        if(d==='DOWN') this.keys.ArrowDown = true;
        if(d==='LEFT') this.keys.ArrowLeft = true;
        if(d==='RIGHT') this.keys.ArrowRight = true;
    },
    stopDir: function() {
        this.keys.ArrowUp = false; this.keys.ArrowDown = false;
        this.keys.ArrowLeft = false; this.keys.ArrowRight = false;
    },
    setAction: function() { this.action = true; },
    stopAction: function() { this.action = false; }
};

// --- Game Logic ---
function update() {
    const p = state.player;
    let dx = 0;
    let dy = 0;

    // 移動処理（グリッド単位で動くRPGらしさ）
    // 今回は「スムーズ移動だが当たり判定はグリッド」にするハイブリッド
    
    if (input.keys.ArrowUp) { dy = -p.speed; p.dir = 0; }
    else if (input.keys.ArrowDown) { dy = p.speed; p.dir = 2; }
    else if (input.keys.ArrowLeft) { dx = -p.speed; p.dir = 3; }
    else if (input.keys.ArrowRight) { dx = p.speed; p.dir = 1; }

    if (dx !== 0 || dy !== 0) {
        // 当たり判定 (移動先の四隅をチェック)
        const margin = 4; // キャラクターのサイズを少し小さく判定
        const nextX = p.x + dx;
        const nextY = p.y + dy;
        
        // 簡易的な衝突判定
        const tl = getTileAt(nextX + margin, nextY + margin); // TopLeft
        const br = getTileAt(nextX + TILE_SIZE - margin, nextY + TILE_SIZE - margin); // BottomRight
        
        if (tl.walk && br.walk) {
            p.x = nextX;
            p.y = nextY;
            p.moving = true;
        }
    } else {
        p.moving = false;
    }

    // カメラ更新 (プレイヤー中心)
    state.camera.x = p.x - SCREEN_W / 2 + TILE_SIZE / 2;
    state.camera.y = p.y - SCREEN_H / 2 + TILE_SIZE / 2;

    // 画面外に行かないようにクランプ
    state.camera.x = Math.max(0, Math.min(state.camera.x, MAP_W * TILE_SIZE - SCREEN_W));
    state.camera.y = Math.max(0, Math.min(state.camera.y, MAP_H * TILE_SIZE - SCREEN_H));

    // アクション判定 (Zキー)
    if(input.action) {
        checkInteraction();
        input.action = false; // 連打防止
    }
}

function checkInteraction() {
    const p = state.player;
    // 向いている方向の1マス先を取得
    let tx = Math.floor((p.x + TILE_SIZE/2) / TILE_SIZE);
    let ty = Math.floor((p.y + TILE_SIZE/2) / TILE_SIZE);
    
    if(p.dir === 0) ty--;
    if(p.dir === 1) tx++;
    if(p.dir === 2) ty++;
    if(p.dir === 3) tx--;

    const targetId = state.map[ty][tx];
    
    if(targetId === TILES.SHOP.id) showMessage("コンビニだ。\\n夜勤の店員が死んだ目をしている。");
    else if(targetId === TILES.BED.id) showMessage("万年床だ。\\n寝ればHP回復できる…かもしれない。");
    else if(targetId === TILES.WALL.id) showMessage("壁だ。乗り越えられない壁だ。");
    else showMessage(""); // メッセージを消す
}

// --- UI System ---
const ui = {
    msgBox: document.getElementById('msg-box'),
    showMsg: function(text) {
        if(!text) {
            this.msgBox.style.display = 'none';
            return;
        }
        this.msgBox.style.display = 'block';
        this.msgBox.innerHTML = text.replace(/\\n/g, '<br>');
    }
};

function showMessage(text) {
    ui.showMsg(text);
}

// --- Renderer ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
// ドット絵をくっきりさせる
ctx.imageSmoothingEnabled = false; 

function draw() {
    // 画面クリア
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, SCREEN_W, SCREEN_H);

    // タイル描画範囲の計算
    const startCol = Math.floor(state.camera.x / TILE_SIZE);
    const endCol = startCol + (SCREEN_W / TILE_SIZE) + 1;
    const startRow = Math.floor(state.camera.y / TILE_SIZE);
    const endRow = startRow + (SCREEN_H / TILE_SIZE) + 1;
    
    const offsetX = -state.camera.x + startCol * TILE_SIZE;
    const offsetY = -state.camera.y + startRow * TILE_SIZE;

    for (let c = startCol; c <= endCol; c++) {
        for (let r = startRow; r <= endRow; r++) {
            if (c >= 0 && c < MAP_W && r >= 0 && r < MAP_H) {
                let tileId = state.map[r][c];
                let tile = Object.values(TILES).find(t => t.id === tileId);
                let x = (c - startCol) * TILE_SIZE + offsetX;
                let y = (r - startRow) * TILE_SIZE + offsetY;
                
                // アセットがあれば画像、なければ単色
                if(tileId === TILES.GRASS.id) ctx.drawImage(assets.grass, x, y);
                else if(tileId === TILES.WALL.id) ctx.drawImage(assets.wall, x, y);
                else if(tileId === TILES.WATER.id) ctx.drawImage(assets.water, x, y);
                else {
                    ctx.fillStyle = tile ? tile.color : '#000';
                    ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                }
            }
        }
    }

    // プレイヤー描画
    const px = state.player.x - state.camera.x;
    const py = state.player.y - state.camera.y;
    ctx.drawImage(assets.player, px, py);
    
    // デバッグ用: 向き表示
    /*
    ctx.fillStyle = 'red';
    if(state.player.dir===0) ctx.fillRect(px+14, py, 4, 4);
    if(state.player.dir===1) ctx.fillRect(px+28, py+14, 4, 4);
    if(state.player.dir===2) ctx.fillRect(px+14, py+28, 4, 4);
    if(state.player.dir===3) ctx.fillRect(px, py+14, 4, 4);
    */
}

// --- Main Loop ---
function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

// --- Init ---
window.onload = function() {
    initAssets();
    generateMap();
    input.init();
    gameLoop();
};

</script>
</body>
</html>
